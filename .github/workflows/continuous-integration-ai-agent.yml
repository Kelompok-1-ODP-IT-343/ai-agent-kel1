name: Continuous Integration AI Agent

on:
  push:
    branches: ["main"]
    tags: ["v*", "release-*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_NAME: ai-agent-kel1

jobs:

  prepare_environment:
    name: Prepare Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
      - run: ls -lah
      - name: Run pytest
        run: |
          if ls | grep -q "tests"; then pytest -q || true; else echo "No tests"; fi

  code_quality:
    name: Code Quality
    needs: prepare_environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_and_push_image:
    name: Build And Push Image
    needs: [prepare_environment, code_quality]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=sha-
            type=ref,event=branch,pattern=main,name=latest
            type=ref,event=tag
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security_scan:
    name: Security Scan
    needs: build_and_push_image
    runs-on: ubuntu-latest

    steps:
    - name: Run Critical Vulnerability Scan
      id: vuln
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: maulanabn99/ai-agent-kel1:sha-9a805c8
        format: json
        vuln-type: os,library
        severity: CRITICAL
        ignore-unfixed: false
        exit-code: 0
        output: trivy-vuln.json

    - name: Run Secret Scan
      id: secrets
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: secret
        format: json
        output: trivy-secrets.json

    - name: Run Misconfiguration Scan
      id: config
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: config
        format: json
        output: trivy-config.json

    - name: Generate Security Summary
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-vuln.json)
        echo "Critical Vulnerabilities: $CRIT" >> $GITHUB_STEP_SUMMARY

        SECRETS=$(jq '.Secrets | length' trivy-secrets.json)
        echo "Secrets Detected: $SECRETS" >> $GITHUB_STEP_SUMMARY

        MISCONF=$(jq '[.Results[].Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' trivy-config.json)
        echo "Critical Misconfigurations: $MISCONF" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Installed | Fixed | CVE | Link |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-----------|-------|-----|------|" >> $GITHUB_STEP_SUMMARY
        jq -r '
          .Results[].Vulnerabilities[]? |
          "| \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") | \(.VulnerabilityID) | \(.PrimaryURL) |"
        ' trivy-vuln.json >> $GITHUB_STEP_SUMMARY